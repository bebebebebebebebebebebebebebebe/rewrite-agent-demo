# Feature Specification: MCP Assistant - 対話型AIアシスタントUI

**Feature Branch**: `001-clients-streamlit-ui`
**Created**: 2025-10-13
**Status**: Draft
**Input**: User description: "clients/streamlit_uiの内容を元にアプリケーションの仕様をまとめてくれますか？"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - AI アシスタントとの基本的な対話 (Priority: P1)

ユーザーは、外部ツールと連携するAIアシスタントにテキストメッセージを送信し、アシスタントの応答と実行されたツールの詳細をリアルタイムで確認できる。

**この優先度の理由**: これがアプリケーションの中核機能であり、ユーザーに最も直接的な価値を提供します。この機能なしでは製品として成立しません。

**独立テスト**: ユーザーがメッセージを入力して送信し、アシスタントからの応答とツール実行情報（サーバー名、ツール名、実行ステータス、パラメータ）が表示されることで完全にテスト可能です。

**Acceptance Scenarios**:

1. **Given** ユーザーがアプリケーションを開いている、**When** メッセージ入力欄にテキストを入力して送信する、**Then** 送信したメッセージが会話履歴に表示され、タイムスタンプが付与される
2. **Given** ユーザーがメッセージを送信した、**When** AIアシスタントが外部ツールを使用して応答を生成する、**Then** アシスタントの応答メッセージ内にツール実行情報（サーバー名、ツール名、実行ステータス、実行時間、パラメータ）が視覚的に区別された形で表示される
3. **Given** ツール実行が成功した、**When** ユーザーが応答を確認する、**Then** ツール実行の結果または成功メッセージが表示される
4. **Given** ツール実行が失敗した、**When** ユーザーが応答を確認する、**Then** エラーの詳細が明確に表示され、ユーザーが問題を理解できる
5. **Given** 会話履歴が存在する、**When** ユーザーがページをスクロールする、**Then** 過去のメッセージとツール実行情報を時系列順に確認できる

---

### User Story 2 - LLMプロバイダーの設定と管理 (Priority: P2)

ユーザーは、使用するLLMプロバイダー（AI提供者）を選択し、APIキーとモデルを設定できる。これにより、複数のAIプロバイダー間で柔軟に切り替えが可能になる。

**この優先度の理由**: ユーザーに柔軟性と選択肢を提供し、異なるAIプロバイダーの特性を活用できるようにします。基本的な対話機能の次に重要な機能です。

**独立テスト**: ユーザーがプロバイダーを選択し、APIキーを入力し、モデルを選択して設定を保存することで、設定が適用され、次の対話で使用されることを確認できます。

**Acceptance Scenarios**:

1. **Given** ユーザーが設定パネルを開いている、**When** 利用可能なLLMプロバイダーのリストを確認する、**Then** 複数のプロバイダー（例：Google Gemini、Anthropic Claude、OpenAI GPT-4）から選択できる
2. **Given** プロバイダーを選択した、**When** APIキーを入力する、**Then** 入力内容がマスク表示され、セキュリティが保たれる
3. **Given** プロバイダーを選択した、**When** 利用可能なモデルのリストを確認する、**Then** 選択したプロバイダーに対応するモデルのみが表示される
4. **Given** 設定を変更した、**When** 保存ボタンをクリックする、**Then** 設定が保存され、成功メッセージが表示される
5. **Given** 設定が保存された、**When** ユーザーがアプリケーションを再起動または再読み込みする、**Then** 保存した設定が維持されている

---

### User Story 3 - 外部ツールサーバーの管理 (Priority: P3)

ユーザーは、AIアシスタントが使用できる外部ツールサーバー（MCP サーバー）を表示、追加、削除でき、各サーバーの接続状態と利用可能なツール数を確認できる。

**この優先度の理由**: ユーザーがアシスタントの能力をカスタマイズし、必要なツールのみを有効化できるようにします。高度なユーザーや管理者向けの機能です。

**独立テスト**: ユーザーがサーバー一覧を表示し、新しいサーバーを追加し、既存のサーバーを削除することで、サーバー管理機能が動作することを確認できます。

**Acceptance Scenarios**:

1. **Given** ユーザーがサーバー管理セクションを開いている、**When** サーバー一覧を確認する、**Then** 各サーバーの名前、接続状態（接続中/切断）、利用可能なツール数が表示される
2. **Given** ユーザーがサーバーを追加したい、**When** 「サーバーを追加」ボタンをクリックする、**Then** サーバー追加フォームが表示され、サーバー名、接続タイプ（コマンド実行/HTTPエンドポイント）、認証情報を入力できる
3. **Given** サーバー追加フォームを入力した、**When** 接続テストを実行する、**Then** サーバーへの接続が成功または失敗し、結果が明確に表示される
4. **Given** サーバーが追加された、**When** ユーザーがサーバー一覧を確認する、**Then** 新しいサーバーが一覧に表示され、接続状態が正しく反映される
5. **Given** 不要なサーバーが存在する、**When** ユーザーがサーバーのオプションメニューから削除を選択する、**Then** 確認ダイアログが表示され、確認後にサーバーが一覧から削除される

---

### User Story 4 - 開発者向けデバッグモード (Priority: P3)

開発者は、デバッグモードを有効化することで、すべてのツール実行の詳細ログ（実行状態、パラメータ、結果、エラー）を時系列で確認でき、問題のトラブルシューティングを効率的に行える。

**この優先度の理由**: 開発者やパワーユーザー向けの高度な機能であり、一般ユーザーには必須ではありません。システムの透明性と問題解決能力を向上させます。

**独立テスト**: ユーザーがデバッグモードを有効化し、ツール実行の詳細ログが表示されることを確認し、デバッグモードを無効化するとログが非表示になることを確認できます。

**Acceptance Scenarios**:

1. **Given** ユーザーがデバッグモードトグルにアクセスできる、**When** トグルをONにする、**Then** デバッグログエリアが表示され、現在のデバッグモード状態が視覚的に示される
2. **Given** デバッグモードが有効、**When** ツール実行が行われる、**Then** ツール実行の詳細（サーバー名、ツール名、開始時刻、実行時間、パラメータ、結果/エラー）が時系列でログエリアに表示される
3. **Given** デバッグログに複数のエントリが存在する、**When** ユーザーがログを確認する、**Then** 総実行数、成功数、エラー数の統計情報が表示される
4. **Given** デバッグモードが有効、**When** トグルをOFFにする、**Then** デバッグログエリアが非表示になり、チャットエリアのみが表示される
5. **Given** ツール実行が失敗した、**When** デバッグログでそのエントリを確認する、**Then** エラーメッセージと失敗の原因が明確に表示される

---

### Edge Cases

- **長時間のツール実行**: ツール実行が予想以上に時間がかかる場合、ユーザーは実行中であることを視覚的に確認でき、タイムアウトが設定されている
- **APIキーの無効化**: 設定されたAPIキーが無効または期限切れの場合、ユーザーに明確なエラーメッセージが表示され、設定の修正を促される
- **サーバー接続の切断**: 外部ツールサーバーとの接続が切断された場合、サーバーの状態が「切断」と表示され、ツール実行時に適切なエラーメッセージが表示される
- **同時実行**: 複数のツールが同時に実行される場合、各ツールの実行状態が独立して追跡され、正しく表示される
- **空のメッセージ送信**: ユーザーが空のメッセージを送信しようとした場合、送信が防止されるか、適切な警告が表示される
- **大量の会話履歴**: 会話履歴が非常に長くなった場合でも、パフォーマンスが低下せず、スムーズにスクロールできる
- **ネットワークエラー**: AIアシスタントまたは外部ツールサーバーへの接続が失敗した場合、ユーザーに分かりやすいエラーメッセージが表示され、再試行のオプションが提供される

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、ユーザーがテキストメッセージを入力して送信できる対話インターフェースを提供しなければならない
- **FR-002**: システムは、ユーザーとAIアシスタント間の会話履歴を時系列順に表示しなければならない
- **FR-003**: システムは、各メッセージにタイムスタンプを付与し、表示しなければならない
- **FR-004**: システムは、AIアシスタントが外部ツールを実行した際、ツール実行情報（サーバー名、ツール名、実行ステータス、実行時間、パラメータ）をアシスタントのメッセージ内に視覚的に区別して表示しなければならない
- **FR-005**: システムは、ツール実行の成功時に結果または成功メッセージを表示しなければならない
- **FR-006**: システムは、ツール実行の失敗時にエラーの詳細を明確に表示しなければならない
- **FR-007**: システムは、複数のLLMプロバイダー（少なくとも3つ以上）をサポートし、ユーザーが選択できなければならない
- **FR-008**: システムは、選択されたLLMプロバイダーに対応する複数のモデルを表示し、ユーザーが選択できなければならない
- **FR-009**: システムは、ユーザーがAPIキーを入力できる機能を提供し、入力内容をマスク表示しなければならない
- **FR-010**: システムは、ユーザーのLLM設定（プロバイダー、モデル、APIキー）をセッション間で永続化しなければならない
- **FR-011**: システムは、接続可能な外部ツールサーバーの一覧を表示し、各サーバーの接続状態（接続中/切断）と利用可能なツール数を示さなければならない
- **FR-012**: システムは、ユーザーが新しい外部ツールサーバーを追加できる機能を提供しなければならない（サーバー名、接続タイプ、認証情報の入力を含む）
- **FR-013**: システムは、外部ツールサーバーへの接続テスト機能を提供し、接続の成功または失敗を報告しなければならない
- **FR-014**: システムは、ユーザーが既存の外部ツールサーバーを削除できる機能を提供しなければならない
- **FR-015**: システムは、開発者向けのデバッグモードを提供し、ONまたはOFFを切り替えられなければならない
- **FR-016**: デバッグモードが有効な場合、システムはすべてのツール実行の詳細ログ（サーバー名、ツール名、開始時刻、実行時間、パラメータ、結果/エラー）を時系列で表示しなければならない
- **FR-017**: デバッグモードが有効な場合、システムはツール実行の統計情報（総実行数、成功数、エラー数）を表示しなければならない
- **FR-018**: システムは、ツール実行中に実行状態（実行中、成功、エラー）を視覚的に区別して表示しなければならない
- **FR-019**: システムは、会話履歴が長くなった場合でもスムーズにスクロールできるパフォーマンスを維持しなければならない
- **FR-020**: システムは、ネットワークエラーやサーバー接続エラーが発生した際に、ユーザーに分かりやすいエラーメッセージを表示しなければならない

### Key Entities

- **Message（メッセージ）**: ユーザーまたはAIアシスタントから送信されたテキストメッセージ。ロール（ユーザー/アシスタント）、内容、タイムスタンプ、関連するツール呼び出し情報を含む
- **Tool Call（ツール呼び出し）**: AIアシスタントが外部ツールを実行した記録。サーバー名、ツール名、実行ステータス（実行中/成功/エラー）、実行時間、パラメータ、結果/エラーメッセージを含む
- **MCP Server（外部ツールサーバー）**: AIアシスタントが使用できる外部ツールを提供するサーバー。名前、接続タイプ（コマンド実行/HTTPエンドポイント）、接続状態（接続中/切断）、利用可能なツール数、アイコンを含む
- **LLM Configuration（LLM設定）**: ユーザーが選択したLLMプロバイダー、モデル、APIキーの組み合わせ。セッション間で永続化される
- **Process Log（プロセスログ）**: デバッグモード用のツール実行の詳細記録。ツール呼び出し情報に加えて、ログID、開始時刻などの追加情報を含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーがメッセージを送信してから、AIアシスタントの応答が表示されるまでの時間が3秒以内である（ツール実行時間を除く）
- **SC-002**: ツール実行情報（サーバー名、ツール名、ステータス）が、アシスタントのメッセージ内で視覚的に区別され、ユーザーの90%が1回目の使用で理解できる
- **SC-003**: ユーザーがLLMプロバイダーとモデルを変更し、設定を保存するまでの操作が5ステップ以内で完了できる
- **SC-004**: 外部ツールサーバーの接続状態（接続中/切断）がリアルタイムで更新され、状態変化から2秒以内にUIに反映される
- **SC-005**: デバッグモードの有効化/無効化が即座に（1秒以内）反映され、ログエリアの表示/非表示が切り替わる
- **SC-006**: 会話履歴が100メッセージ以上になっても、スクロール操作が滑らかで遅延が感じられない（60fps以上）
- **SC-007**: エラー発生時に、ユーザーの80%以上が表示されたエラーメッセージから問題の原因を理解できる
- **SC-008**: 新規ユーザーが初めてメッセージを送信し、アシスタントの応答を確認するまでの時間が2分以内である
- **SC-009**: システムは、10個以上の外部ツールサーバーを同時に管理でき、パフォーマンスの低下なく動作する
- **SC-010**: デバッグモードで、ツール実行ログが50件以上表示されても、ログの確認とスクロールが快適に行える

## Assumptions

1. ユーザーは有効なAPIキーを持っており、自分で取得・管理できる
2. 外部ツールサーバーは標準的なMCP（Model Context Protocol）に準拠している
3. ユーザーのネットワーク接続は安定しており、基本的な帯域幅がある
4. ユーザーはモダンなWebブラウザ（最新2バージョン以内のChrome、Firefox、Safari、Edge）を使用している
5. AIアシスタントの応答品質は使用するLLMプロバイダーとモデルに依存し、システムの責任範囲外である
6. セッションデータ（会話履歴、設定）はブラウザのローカルストレージまたは同等の仕組みで保存される
7. デバッグモードは主に開発者とパワーユーザー向けであり、一般ユーザーはデフォルトでOFFの状態で使用する
8. 外部ツールサーバーの追加と削除は、システムの再起動を必要としない
